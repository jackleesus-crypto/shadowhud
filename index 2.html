<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ShadowHUD v11.8.4 (onefile)</title>
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>

:root{--bg:#000;--panel:#0b0b0b;--card:#101010;--line:#202020;--muted:#9aa0a6;--accent:#8da2ff;--accent2:#b98cff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:#fff;font:16px/1.45 -apple-system,system-ui}
.appbar{position:sticky;top:0;display:flex;align-items:center;gap:12px;padding:14px 18px;background:#0a0a0a;border-bottom:1px solid var(--line);z-index:50}
.brand{font-weight:700}.ver{opacity:.6;margin-left:6px}
.gold{margin-left:auto}
.content{padding:18px 16px 100px;max-width:820px;margin:0 auto}
.section{margin:6px 2px 10px 2px;font-weight:800;letter-spacing:.3px}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:8px 12px;border-radius:16px;background:#141414;border:1px solid var(--line);color:#ddd}
.chip.active{outline:2px solid var(--accent)}
.stack{display:flex;flex-direction:column;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.tile{background:#0f0f0f;border:1px solid var(--line);border-radius:12px;padding:14px;text-align:center}
.tname{font-size:12px;opacity:.8}.tval{font-size:22px;font-weight:700;margin-top:2px}
.row{display:flex;align-items:center}.between{justify-content:space-between}
.row.gap{gap:10px}
.title{font-weight:700;margin-bottom:10px}
.bar{height:10px;background:#1a1a1a;border-radius:10px;overflow:hidden;margin:10px 0;border:1px solid var(--line)}
#xpbar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.stats{justify-content:space-between}
.ach{margin:0;padding-left:18px}
.fab{position:fixed;right:20px;bottom:100px;border:none;border-radius:20px;padding:12px 16px;background:var(--accent);color:#000;font-weight:800}
.tabs{position:fixed;left:0;right:0;bottom:0;display:flex;background:#0a0a0a;border-top:1px solid var(--line)}
.tab{flex:1;padding:12px 6px;background:transparent;color:#c8c8c8;border:none}
.tab.active{color:#fff;border-top:2px solid var(--accent)}
.q{padding:14px;border:1px solid var(--line);background:#0f0f0f;border-radius:12px}
.q .head{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.badge{font-size:12px;padding:2px 8px;background:#151515;border:1px solid var(--line);border-radius:10px;color:#ccc}
.q .title{font-weight:800}
.q .sub{opacity:.8;margin-top:2px}
.rowbtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{background:#141414;color:#eee;border:1px solid var(--line);border-radius:10px;padding:8px 12px}
.btn.primary{background:var(--accent);color:#000;font-weight:800}
.empty{opacity:.6;text-align:center;margin-top:8px}
.counter{display:flex;gap:8px;align-items:center;margin:6px 0}
.circle{width:22px;height:22px;border-radius:50%;border:2px solid #666;display:inline-flex;align-items:center;justify-content:center;color:#666}
.circle.done{background:var(--accent);color:#000;border-color:var(--accent)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:flex-end}
.modal.hidden{display:none}
.sheet{background:#0b0b0b;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;width:100%;border-top:1px solid var(--line);max-width:820px;margin:0 auto}
label{display:block;margin:10px 0}input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b0b0b;color:#fff}
.focus-time{font-size:36px;font-weight:800;margin:8px 0}
@media (min-width:820px){ .content{padding:24px 0 110px} }

.screen{display:none}.screen.active{display:block}

.screen{display:none} .screen.active{display:block}
</style>
</head>
<body>

  <header class="appbar">
    <div class="brand">ShadowHUD <span class="ver">v11.8.2</span></div>
    <div class="spacer"></div>
    <div class="gold">ðŸ’° <span id="gold">0</span></div>
  </header>

  <main class="content">
    <section id="screen-quests" class="screen">
      <h2 class="section">Quests</h2>
      <div class="filters">
        <button class="chip active" data-filter="all">All</button>
        <button class="chip" data-filter="daily">Daily</button>
        <button class="chip" data-filter="penalty">Penalty</button>
        <button class="chip" data-filter="active">Active</button>
        <button class="chip" data-filter="completed">Done</button>
      </div>
      <div id="quest-list" class="stack"></div>
      <div id="empty-quests" class="empty">No quests yet. Tap ï¼‹ to add.</div>
      <button id="fab-add" class="fab">ï¼‹</button>
    </section>

    <section id="screen-journey" class="screen">
      <h2 class="section">Journey</h2>
      <div class="card">
        <div class="row between">
          <div class="lvl">Level <span id="lvl">1</span> Â· <span id="rank">E</span></div>
          <div class="xp"><span id="xp">0</span>/<span id="xpreq">0</span> XP</div>
        </div>
        <div class="bar"><div id="xpbar"></div></div>
        <div class="row stats">
          <div><b>Completed</b><br><span id="done">0</span></div>
          <div><b>Streak</b><br><span id="streak">0</span></div>
          <div><b>Gold</b><br><span id="jg">0</span></div>
        </div>
      </div>
      <div class="card">
        <div class="title">Achievements</div>
        <ul id="ach" class="ach"></ul>
      </div>
    </section>

    <section id="screen-character" class="screen active">
      <h2 class="section">Character</h2>
      <div class="card">
        <div class="grid-3 attrs">
          <div class="tile"><div class="tname">PHYSICAL</div><div id="attr-Physical" class="tval">0</div></div>
          <div class="tile"><div class="tname">PSYCHE</div><div id="attr-Psyche" class="tval">0</div></div>
          <div class="tile"><div class="tname">INTELLECT</div><div id="attr-Intellect" class="tval">0</div></div>
          <div class="tile"><div class="tname">SOCIAL</div><div id="attr-Social" class="tval">0</div></div>
          <div class="tile"><div class="tname">SPIRITUAL</div><div id="attr-Spiritual" class="tval">0</div></div>
          <div class="tile"><div class="tname">FINANCIAL</div><div id="attr-Financial" class="tval">0</div></div>
        </div>
      </div>
      <div class="card">
        <canvas id="radar" width="640" height="420"></canvas>
      </div>
    </section>

    <section id="screen-store" class="screen">
      <h2 class="section">Store</h2>
      <div class="row between">
        <div>ðŸ’° <span id="gold2">0</span> Gold</div>
        <button id="btn-new-reward" class="btn">ï¼‹ New Reward</button>
      </div>
      <div id="rewards" class="stack"></div>
      <form id="reward-form" class="card hidden">
        <div class="title">New Reward</div>
        <label>Title<input id="r-title" required></label>
        <label>Cost (Gold)<input id="r-cost" type="number" min="1" value="50"></label>
        <div class="row gap">
          <button class="btn primary" type="submit">Save</button>
          <button class="btn" type="button" id="r-cancel">Cancel</button>
        </div>
      </form>
    </section>

    <section id="screen-focus" class="screen">
      <h2 class="section">Focus</h2>
      <div class="card">
        <label>Minutes<input id="focus-min" type="number" min="1" value="25"></label>
        <div class="focus-time" id="focus-time">25:00</div>
        <div class="row gap">
          <button id="f-start" class="btn primary">Start</button>
          <button id="f-pause" class="btn hidden">Pause</button>
          <button id="f-resume" class="btn hidden">Resume</button>
          <button id="f-cancel" class="btn">Cancel</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs">
    <button class="tab active" data-to="character">Character</button>
    <button class="tab" data-to="quest">Quest</button>
    <button class="tab" data-to="journey">Journey</button>
    <button class="tab" data-to="store">Store</button>
    <button class="tab" data-to="focus">Focus</button>
  </nav>

  <div id="modal" class="modal hidden">
    <div class="sheet">
      <h3 id="m-title">New/Edit Quest</h3>
      <form id="qform">
        <label>Title<input id="q-title" required></label>
        <label>Description<input id="q-desc" placeholder="Optional"></label>
        <fieldset>
          <legend>Attributes (amounts)</legend>
          <label><input type="checkbox" class="attr" data-name="Physical"> Physical <input class="amt" data-name="Physical" type="number" min="1" value="1"></label>
          <label><input type="checkbox" class="attr" data-name="Psyche"> Psyche <input class="amt" data-name="Psyche" type="number" min="1" value="1"></label>
          <label><input type="checkbox" class="attr" data-name="Intellect"> Intellect <input class="amt" data-name="Intellect" type="number" min="1" value="1"></label>
          <label><input type="checkbox" class="attr" data-name="Social"> Social <input class="amt" data-name="Social" type="number" min="1" value="1"></label>
          <label><input type="checkbox" class="attr" data-name="Spiritual"> Spiritual <input class="amt" data-name="Spiritual" type="number" min="1" value="1"></label>
          <label><input type="checkbox" class="attr" data-name="Financial"> Financial <input class="amt" data-name="Financial" type="number" min="1" value="1"></label>
        </fieldset>
        <label>Type
          <select id="q-type">
            <option value="timer">Timer</option>
            <option value="counter">Counter</option>
            <option value="checklist">Checklist</option>
            <option value="multicounter">Multi-counter</option>
          </select>
        </label>
        <div data-if="timer"><label>Duration (min)<input id="q-min" type="number" min="1" value="30"></label></div>
        <div data-if="counter"><label>Target Count<input id="q-target" type="number" min="1" value="10"></label></div>
        <div data-if="checklist"><label>Checklist (comma)<input id="q-items" placeholder="Warm up, Run 2km, Stretch"></label></div>
        <div data-if="multicounter"><label>Multi items label:target (comma)<input id="q-multi" placeholder="Pushups:100, Sit-ups:100, Squats:100, Run (miles):1"></label></div>
        <label>Difficulty
          <select id="q-diff">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
            <option value="elite">Elite</option>
            <option value="boss">Boss</option>
          </select>
        </label>
        <label><input id="q-daily" type="checkbox"> Treat as Daily</label>
        <label>Base XP<input id="q-xp" type="number" min="0" value="25"></label>
        <div class="row gap">
          <button class="btn primary" type="submit">Save</button>
          <button class="btn" type="button" id="q-cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="app.js?v=118"></script>

<script>
(function(){
  var b=document.createElement('div');
  b.style.cssText='position:fixed;left:0;top:0;right:0;padding:6px 10px;background:#111;color:#0f0;font:12px -apple-system,system-ui;z-index:9999;opacity:.9';
  b.id='diag'; b.textContent='JS bootâ€¦'; document.body.appendChild(b);
  window.addEventListener('error',function(e){ b.textContent='Error: '+(e.message||e.error); }, true);
  window.addEventListener('unhandledrejection',function(e){ b.textContent='Promise: '+e.reason; });
})();
</script>
<script>

// Polyfills
(function(){
  if(typeof window.structuredClone!=='function'){ window.structuredClone=(o)=>{try{return JSON.parse(JSON.stringify(o));}catch(e){return o;}}; }
})();

const LS='shadowhud.v11.8';
const state = load() || {
  wallet:{gold:0}, level:{xp:0,lvl:1},
  attrs:{Physical:0,Psyche:0,Intellect:0,Social:0,Spiritual:0,Financial:0},
  stats:{completed:0,currentStreak:0,longestStreak:0,lastCompletionDay:null},
  quests:[], rewards:[], lastDailyKey:null
};

function save(){ localStorage.setItem(LS,JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS)); }catch(e){ return null; } }
function uid(){ return Math.floor(Math.random()*1e9)+Date.now(); }
function todayKey(){ const d=new Date(); return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(); }
function endOfToday(){ const d=new Date(); d.setHours(23,59,59,999); return d.toISOString(); }

// Leveling
function xpForLevel(l){ return Math.round(40 + (l-1)*(l<30?7:(l<60?12:20))); }
function rankForLevel(l){ if(l<=15)return'E'; if(l<=30)return'D'; if(l<=45)return'C'; if(l<=60)return'B'; if(l<=80)return'A'; return 'S'; }
function addXP(n){ state.level.xp+=n; while(state.level.xp>=xpForLevel(state.level.lvl)){ state.level.xp-=xpForLevel(state.level.lvl); state.level.lvl++; } save(); renderJourney(); renderCharacter(); }
function addGold(n){ state.wallet.gold+=n; save(); renderCharacter(); }

// Rewards
const diffScale={easy:1,normal:1.2,hard:1.6,elite:2.2,boss:3};
function rewardFromBase(base,diff){ return Math.round(base*(diffScale[diff]||1)); }
function goldFromBase(base,diff){ return Math.max(5,Math.round(base*(diffScale[diff]||1)*0.4)); }

// Dailies
function seedTodayDailiesIfMissing(){
  const key=todayKey();
  if(state.quests.some(q=>q.daily&&q.dayKey===key)) return;
  const d=[];
  d.push({id:uid(),title:'Strength Training',type:'multicounter',diff:'elite',baseXP:60,daily:true,dayKey:key,deadline:endOfToday(),
    attrs:[{name:'Physical',amt:2}],
    metrics:[{label:'Pushups',target:100,count:0},{label:'Sit-ups',target:100,count:0},{label:'Squats',target:100,count:0},{label:'Run (miles)',target:1,count:0}],
    completed:false,started:false
  });
  d.push({id:uid(),title:'Meditate 10 min',type:'timer',durationMin:10,durationMs:600000,diff:'normal',baseXP:20,daily:true,dayKey:key,deadline:endOfToday(),
    attrs:[{name:'Spiritual',amt:1},{name:'Psyche',amt:1}],completed:false,started:false});
  d.push({id:uid(),title:'Journal 1 page',type:'checklist',items:['What went well?','What to improve?','One intention for tomorrow'],done:[false,false,false],diff:'easy',baseXP:12,
    daily:true,dayKey:key,deadline:endOfToday(),attrs:[{name:'Intellect',amt:1},{name:'Psyche',amt:1}],completed:false,started:false});
  state.quests=d.concat(state.quests); save();
}
function makePenalty(){
  const choices=['Penalty â€” 50 pushups','Penalty â€” 25 burpees','Penalty â€” tidy desk','Penalty â€” 15 min walk'];
  const t=choices[Math.floor(Math.random()*choices.length)];
  return {id:uid(),title:t,type:'counter',target:1,count:0,diff:'normal',baseXP:8,penalty:true};
}
function midnightSweepIfNeeded(){
  const key=todayKey(); if(state.lastDailyKey===key) return;
  const keep=[],pen=[];
  for(const q of state.quests){ if(q.daily){ if(!q.completed) pen.push(makePenalty()); } else keep.push(q); }
  state.quests=keep.concat(pen); seedTodayDailiesIfMissing(); state.lastDailyKey=key; save();
}

// Render
let currentFilter='all';
function renderCharacter(){
  document.getElementById('gold').textContent=state.wallet.gold;
  document.getElementById('gold2')?.textContent = state.wallet.gold;
  // attrs
  for(const k in state.attrs){ const el=document.getElementById('attr-'+k); if(el) el.textContent=state.attrs[k]; }
  // radar
  drawRadar();
}
function renderJourney(){
  document.getElementById('lvl').textContent=state.level.lvl;
  document.getElementById('rank').textContent=rankForLevel(state.level.lvl);
  document.getElementById('xp').textContent=state.level.xp;
  document.getElementById('xpreq').textContent=xpForLevel(state.level.lvl);
  document.getElementById('xpbar').style.width = Math.min(100,Math.round(state.level.xp/xpForLevel(state.level.lvl)*100))+'%';
  document.getElementById('done').textContent=state.stats.completed;
  document.getElementById('streak').textContent=state.stats.currentStreak||0;
  document.getElementById('jg').textContent=state.wallet.gold;
}
function btn(text,fn){ const b=document.createElement('button'); b.className='btn'; b.textContent=text; b.onclick=fn; return b; }

function renderQuests(){
  const list=document.getElementById('quest-list'); list.innerHTML='';
  let qs=state.quests.slice();
  if(currentFilter==='daily') qs=qs.filter(q=>q.daily);
  if(currentFilter==='penalty') qs=qs.filter(q=>q.penalty);
  if(currentFilter==='active') qs=qs.filter(q=>q.started && !q.completed);
  if(currentFilter==='completed') qs=qs.filter(q=>q.completed);
  document.getElementById('empty-quests').style.display = qs.length? 'none':'block';
  qs.forEach(q=>{
    const c=document.createElement('div'); c.className='q';
    const head=document.createElement('div'); head.className='head';
    const tag = q.penalty?'<span class="badge">Penalty</span>':(q.daily?'<span class="badge">Daily</span>':'');
    head.innerHTML = `${tag}<span class="badge">${q.diff||'normal'}</span><div class="title">${q.title}</div>`;
    c.appendChild(head);
    const sub=document.createElement('div'); sub.className='sub';
    const xp=`+${rewardFromBase(q.baseXP||25,q.diff)} XP Â· ðŸ’° ${goldFromBase(q.baseXP||25,q.diff)}`;
    sub.textContent = xp; c.appendChild(sub);

    if(q.type==='counter'){
      const row=document.createElement('div'); row.className='row gap';
      const span=document.createElement('div'); span.textContent=`${q.count||0} / ${q.target||1}`;
      row.append(span, btn('Finish',()=>{q.count=q.target||1; complete(q); renderQuests(); save();}), btn('âˆ’1',()=>{q.count=Math.max(0,(q.count||0)-1); save(); renderQuests();}), btn('+1',()=>{q.count=(q.count||0)+1; if(q.count>=q.target) complete(q); save(); renderQuests();}));
      c.appendChild(row);
    }
    if(q.type==='checklist'){
      q.done=q.done||q.items.map(()=>false);
      q.items.forEach((it,i)=>{
        const row=document.createElement('div'); row.className='counter';
        const dot=document.createElement('div'); dot.className='circle'+(q.done[i]?' done':''); dot.textContent=q.done[i]?'âœ“':'';
        dot.onclick=()=>{ q.done[i]=!q.done[i]; if(q.done.every(Boolean)) complete(q); save(); renderQuests(); };
        row.append(dot, document.createTextNode(it)); c.appendChild(row);
      });
    }
    if(q.type==='multicounter'){
      (q.metrics||[]).forEach(m=>{
        const row=document.createElement('div'); row.className='row gap';
        row.append(document.createTextNode(`${m.label}`), document.createTextNode(` ${m.count||0} / ${m.target}`),
          btn('Finish',()=>{ m.count=m.target; checkMulti(q); save(); renderQuests(); }),
          btn('âˆ’1',()=>{ m.count=Math.max(0,(m.count||0)-1); save(); renderQuests(); }),
          btn('+1',()=>{ m.count=Math.min(m.target,(m.count||0)+1); checkMulti(q); save(); renderQuests(); }));
        c.appendChild(row);
      });
    }
    if(q.type==='timer'){
      const disp=document.createElement('div'); disp.id='t-'+q.id; disp.textContent=timeLeftText(q); c.appendChild(disp);
      const row=document.createElement('div'); row.className='row gap';
      row.append(btn('Start',()=>{ if(!q.started){ q.started=true; q.tStart=Date.now(); q.tLeft=(q.durationMs||(q.durationMin||10)*60000); } tickTimers(); save(); renderQuests(); }),
                 btn('Pause',()=>{ if(q.started){ q.tLeft=Math.max(0,(q.tLeft||0)-(Date.now()-q.tStart)); q.started=false; } save(); renderQuests(); }),
                 btn('Resume',()=>{ if(!q.started&&q.tLeft>0){ q.started=true; q.tStart=Date.now(); } save(); renderQuests(); }),
                 btn('Done',()=>{ complete(q); save(); renderQuests(); }));
      c.appendChild(row);
    }

    const tail=document.createElement('div'); tail.className='rowbtns';
    tail.append(btn('Reset',()=>{ resetQuest(q); save(); renderQuests(); }),
                btn('Delete',()=>{ state.quests=state.quests.filter(x=>x.id!==q.id); save(); renderQuests(); }));
    c.appendChild(tail);

    list.appendChild(c);
  });
}

function resetQuest(q){
  if(q.type==='counter'){ q.count=0; }
  if(q.type==='checklist'){ q.done=q.items.map(()=>false); }
  if(q.type==='multicounter'){ q.metrics.forEach(m=>m.count=0); }
  if(q.type==='timer'){ q.started=false; q.tLeft=(q.durationMs||(q.durationMin||10)*60000); }
  q.completed=false;
}
function checkMulti(q){ if(q.metrics.every(m=>m.count>=m.target)) complete(q); }
function timeLeftText(q){ if(!q.started){ return (q.durationMin||Math.round((q.durationMs||0)/60000))+':00'; } const el=Date.now()-q.tStart; const left=Math.max(0,(q.tLeft||q.durationMs)-el); const m=Math.floor(left/60000), s=String(Math.floor((left%60000)/1000)).padStart(2,'0'); if(left===0){ complete(q);} return m+':'+s; }

function complete(q){
  if(q.completed) return; q.completed=true;
  const xp=rewardFromBase(q.baseXP||25,q.diff||'normal'); const gold=goldFromBase(q.baseXP||25,q.diff||'normal');
  addXP(xp); addGold(gold);
  if(q.attrs){ q.attrs.forEach(a=>{ state.attrs[a.name]=(state.attrs[a.name]||0)+(a.amt||1); }); }
  state.stats.completed+=1; state.stats.lastCompletionDay=todayKey();
  save(); renderCharacter(); renderJourney();
}

function drawRadar(){
  const cv=document.getElementById('radar'); if(!cv) return; const ctx=cv.getContext('2d');
  const w=cv.width, h=cv.height; ctx.clearRect(0,0,w,h);
  const labels=['Physical','Psyche','Intellect','Social','Spiritual','Financial'];
  const vals=labels.map(k=>state.attrs[k]);
  const max=Math.max(5, ...vals, 10);
  const cx=w/2, cy=h/2+20, r=Math.min(w,h)/2 - 50;
  // grid
  ctx.strokeStyle='#222'; ctx.lineWidth=1;
  for(let ring=1; ring<=5; ring++){ ctx.beginPath(); for(let i=0;i<labels.length;i++){ const ang=(Math.PI*2/labels.length)*i - Math.PI/2; const rr=r*ring/5; const x=cx+Math.cos(ang)*rr; const y=cy+Math.sin(ang)*rr; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.closePath(); ctx.stroke(); }
  // axes + labels
  ctx.fillStyle='#aaa'; ctx.font='16px -apple-system,system-ui'; ctx.textAlign='center';
  for(let i=0;i<labels.length;i++){ const ang=(Math.PI*2/labels.length)*i - Math.PI/2; const x=cx+Math.cos(ang)*(r+16); const y=cy+Math.sin(ang)*(r+16); ctx.fillText(labels[i],x,y); }
  // value shape
  ctx.beginPath(); for(let i=0;i<labels.length;i++){ const ang=(Math.PI*2/labels.length)*i - Math.PI/2; const p=vals[i]/max; const x=cx+Math.cos(ang)*(r*p); const y=cy+Math.sin(ang)*(r*p); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
  ctx.closePath(); ctx.fillStyle='rgba(141,162,255,0.25)'; ctx.fill(); ctx.strokeStyle='#8da2ff'; ctx.lineWidth=2; ctx.stroke();
}

// Store
function renderStore(){
  const list=document.getElementById('rewards'); list.innerHTML='';
  if(!state.rewards.length){ const e=document.createElement('div'); e.className='empty'; e.textContent='No rewards yet.'; list.appendChild(e); }
  state.rewards.forEach((r,i)=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div class="title">${r.title}</div><div>Cost: ðŸ’° ${r.cost}</div>`;
    c.appendChild(btn('Buy',()=>{ if(state.wallet.gold>=r.cost){ state.wallet.gold-=r.cost; save(); renderCharacter(); renderStore(); } }));
    list.appendChild(c);
  });
}

// Modal/new quest
document.getElementById('fab-add').addEventListener('click',()=>openModal());
document.getElementById('q-cancel').addEventListener('click',()=>document.getElementById('modal').classList.add('hidden'));
document.getElementById('q-type').addEventListener('change',updateTypeFields);
function updateTypeFields(){ const t=document.getElementById('q-type').value; document.querySelectorAll('[data-if]').forEach(el=>el.style.display = el.getAttribute('data-if')===t ? 'block' : 'none'); }
updateTypeFields();
document.getElementById('qform').addEventListener('submit', e=>{
  e.preventDefault();
  const q={ id:uid(), title:val('q-title'), desc:val('q-desc'), type:val('q-type'), diff:val('q-diff'), baseXP:Number(val('q-xp')||25),
    daily: byId('q-daily').checked, dayKey: byId('q-daily').checked? todayKey(): null, deadline: byId('q-daily').checked? endOfToday(): null,
    completed:false, started:false };
  if(q.type==='timer'){ q.durationMin=Number(val('q-min')||30); q.durationMs=q.durationMin*60000; }
  if(q.type==='counter'){ q.target=Number(val('q-target')||10); q.count=0; }
  if(q.type==='checklist'){ q.items=val('q-items').split(',').map(s=>s.trim()).filter(Boolean); q.done=q.items.map(()=>false); }
  if(q.type==='multicounter'){ q.metrics=val('q-multi').split(',').map(s=>s.trim()).filter(Boolean).map(p=>{ const [l,t]=p.split(':'); return {label:(l||'Item'),target:Number(t||1),count:0}; }); }
  const attrs=[]; document.querySelectorAll('#qform .attr').forEach(chk=>{ const name=chk.dataset.name; const on=chk.checked; const amtEl=document.querySelector(`#qform .amt[data-name="${name}"]`); if(on){ attrs.push({name,amt:Number(amtEl.value||1)}); }});
  q.attrs=attrs;
  state.quests.unshift(q); save(); document.getElementById('modal').classList.add('hidden'); renderQuests();
});
function val(id){ return document.getElementById(id).value; } function byId(id){ return document.getElementById(id); }

// Tabs
document.querySelectorAll('.tabs .tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const to=b.dataset.to; document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    if(to==='quest'){ byId('screen-quests').classList.add('active'); renderQuests(); }
    if(to==='journey'){ byId('screen-journey').classList.add('active'); renderJourney(); }
    if(to==='character'){ byId('screen-character').classList.add('active'); renderCharacter(); }
    if(to==='store'){ byId('screen-store').classList.add('active'); renderStore(); }
    if(to==='focus'){ byId('screen-focus').classList.add('active'); }
  });
});

// Filters
document.querySelectorAll('[data-filter]').forEach(c=>c.addEventListener('click',()=>{
  document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('active'));
  c.classList.add('active'); currentFilter=c.dataset.filter; renderQuests();
}));

// Focus
let fTimer=null,fEnd=0,fPauseLeft=0;
function fmt(ms){ const m=Math.floor(ms/60000), s=String(Math.floor((ms%60000)/1000)).padStart(2,'0'); return `${m}:${s}`; }
function updateFocus(){ const out=byId('focus-time'); if(!fTimer){ out.textContent = fmt((byId('focus-min').value||25)*60000); return; } const left=Math.max(0,fEnd-Date.now()); out.textContent=fmt(left); if(left<=0){ clearInterval(fTimer); fTimer=null; } }
byId('f-start').onclick=()=>{ const ms=Number(byId('focus-min').value||25)*60000; fEnd=Date.now()+ms; clearInterval(fTimer); fTimer=setInterval(updateFocus,500); byId('f-pause').classList.remove('hidden'); byId('f-start').classList.add('hidden'); };
byId('f-pause').onclick=()=>{ fPauseLeft=Math.max(0,fEnd-Date.now()); clearInterval(fTimer); fTimer=null; byId('f-pause').classList.add('hidden'); byId('f-resume').classList.remove('hidden'); };
byId('f-resume').onclick=()=>{ fEnd=Date.now()+fPauseLeft; fTimer=setInterval(updateFocus,500); byId('f-resume').classList.add('hidden'); byId('f-pause').classList.remove('hidden'); };
byId('f-cancel').onclick=()=>{ clearInterval(fTimer); fTimer=null; byId('f-start').classList.remove('hidden'); byId('f-pause').classList.add('hidden'); byId('f-resume').classList.add('hidden'); updateFocus(); };

// Timers in quests
function tickTimers(){ clearInterval(window.__tick); window.__tick=setInterval(()=>{ document.querySelectorAll('[id^=t-]').forEach(el=>{ const id=Number(el.id.slice(2)); const q=state.quests.find(x=>x.id===id); if(q) el.textContent=timeLeftText(q); }); }, 500); }

// Startup
function init(){ midnightSweepIfNeeded(); seedTodayDailiesIfMissing(); renderCharacter(); renderJourney(); renderQuests(); tickTimers(); }
document.addEventListener('DOMContentLoaded', init);

try{document.getElementById('diag').textContent='JS OK';}catch(e){}
</script>
</body>
</html>
